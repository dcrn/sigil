{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/dcrn/sigil/schema/contract.schema.json",
  "title": "Sigil Contract",
  "description": "Schema for Sigil contract files.",
  "type": "object",
  "required": ["id", "version", "name", "description"],
  "additionalProperties": true,
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
      "description": "Unique identifier in kebab-case. Must match the filename (without .contract.toml suffix). Uniqueness across files is enforced by the tool, not this schema."
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(-(0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(\\.(0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*)?$",
      "description": "Semantic version string tracking contract evolution."
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable name displayed in listings and summaries."
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "description": "Plain language description of the rule this contract upholds. The most important field -- this is what agents read to understand intent."
    },
    "priority": {
      "type": "string",
      "enum": ["must", "should", "prefer"],
      "default": "must",
      "description": "Enforcement level. 'must' fails CI on violation, 'should' produces warnings, 'prefer' is informational."
    },
    "status": {
      "type": "string",
      "enum": ["active", "draft", "deprecated"],
      "default": "active",
      "description": "Lifecycle state. 'draft' is not enforced in CI and signals work-in-progress. 'active' is fully enforced. 'deprecated' is still enforced but agents should not create new dependencies on it; CI warns rather than fails regardless of priority."
    },
    "domain": {
      "type": "string",
      "description": "Freeform grouping label for filtering (e.g., 'ingestion', 'auth', 'billing')."
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true,
      "description": "Additional labels for discovery and filtering. Empty strings are not allowed -- they would silently break tag-based filtering."
    },
    "applies_to": {
      "oneOf": [
        {
          "type": "string",
          "minLength": 1,
          "description": "A single glob pattern for files this contract applies to."
        },
        {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "description": "A list of glob patterns for files this contract applies to."
        }
      ],
      "description": "Glob patterns for files this contract applies to. When set, the contract is automatically included in affected-contracts queries when queried files match. Use '**' for global contracts. Empty strings are not allowed -- they match nothing and are always a mistake."
    },
    "trigger": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "type": {
          "type": "string",
          "description": "The kind of event (e.g. 'kafka-message', 'http-request', 'mcp-tool-call', 'cron')."
        }
      },
      "description": "What initiates this contract's rule. 'type' is the only conventionally used key. Everything else is freeform domain context for the agent."
    },
    "files": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "description": "File paths relative to the repo root that this contract cares about. Used at contract level for source files, config, and schemas relevant to the whole contract."
    },
    "rules": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/rule"
      },
      "description": "Expected rules when the contract's trigger fires. rule.id must be unique within the array (enforced by the tool, not this schema)."
    },
    "notes": {
      "type": "string",
      "description": "Freeform space for context, historical decisions, known edge cases, or links to external documentation."
    },
    "changelog": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/changelog-entry"
      },
      "description": "History of contract changes. Helps agents understand why constraints exist without reading git blame."
    }
  },
  "$defs": {
    "rule": {
      "type": "object",
      "required": ["id", "description"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
          "description": "Unique identifier for this rule within the contract. Uniqueness within the array is enforced by the tool."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "What should happen when this rule is triggered."
        },
        "files": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "File paths specific to this rule (e.g. migrations, schemas, config files)."
        },
        "constraints": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Freeform invariants that must hold for this rule. Interpreted by agents; not validated structurally."
        }
      }
    },
    "changelog-entry": {
      "type": "object",
      "required": ["version", "description"],
      "additionalProperties": false,
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(-(0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(\\.(0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*)?$",
          "description": "The contract version this entry describes."
        },
        "date": {
          "type": "string",
          "format": "date",
          "description": "ISO 8601 date when this version was published (e.g., '2026-02-20')."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "What changed and why. Context here saves future agents from reading git blame."
        }
      }
    }
  }
}
