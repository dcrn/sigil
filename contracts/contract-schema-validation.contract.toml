id = "contract-schema-validation"
version = "1.0.0"
name = "Contract Schema Validation"
description = """
All contract TOML files must conform to the Sigil contract schema defined in \
schema/contract.schema.json. The MCP server validates contracts on load, on creation, \
and on update. Validation errors are reported with enough detail for the caller to fix \
the problem (field path, expected type, actual value). Contracts that fail validation \
are never written to disk by the create or update tools. The server must be able to load \
and report on contracts that have validation errors (e.g., in health checks) without crashing.
"""
priority = "must"
status = "active"
domain = "core"
tags = ["validation", "schema", "toml"]
files = [
    "schema/contract.schema.json",
    "src/model.rs",
    "src/tools/loader.rs",
]

[[rules]]
id = "validate-on-load"
description = """
When the server starts or reloads contracts, each TOML file in the contracts directory \
is validated against the schema. Files that fail validation are tracked as having errors \
but do not prevent other contracts from loading.
"""
files = ["schema/contract.schema.json"]
constraints = [
    "Invalid contracts must not cause the server to crash or refuse to start",
    "Validation errors must include the file path and specific field failures",
]

[[rules]]
id = "validate-on-write"
description = """
When sigil_create_contract or sigil_update_contract is called, the resulting contract is \
validated before being written to disk. If validation fails, the file is not written \
and the errors are returned.
"""
files = ["schema/contract.schema.json"]
constraints = [
    "Invalid contracts must never be written to disk",
    "The response must include all validation errors, not just the first one",
]

[[rules]]
id = "report-in-health"
description = """
sigil_get_contract_health includes a validation_errors list containing all contracts that \
fail schema validation, with details about what is wrong.
"""
constraints = [
    "Each entry must include the contract id and the list of validation failures",
]
